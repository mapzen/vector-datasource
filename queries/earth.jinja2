{% if zoom < 9 %}

SELECT
    gid AS __id__,
    {% filter geometry %}{{ bounds['polygon']|bbox_intersection('the_geom') }}{% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_earth(t.*) AS mz_properties,
    jsonb_build_object(
      'source', 'naturalearthdata.com',
      'min_zoom', mz_earth_min_zoom,
      'gid', gid
    ) AS __properties__
FROM
{% if zoom < 2 %}
    ne_110m_land t
{% elif 2 <= zoom < 5 %}
    ne_50m_land t
{% elif 5 <= zoom < 9 %}
    ne_10m_land t
{% endif %}

WHERE
    mz_earth_min_zoom < {{ zoom + 1 }} AND
    {{ bounds['polygon']|bbox_filter('the_geom',3857) }}

{% else %}

SELECT
    gid AS __id__,
    {% filter geometry %}{{ bounds['polygon']|bbox_intersection('the_geom') }}{% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_earth(t.*) AS mz_properties,
    jsonb_build_object(
      'source', 'openstreetmapdata.com'
    ) AS __properties__

FROM
    land_polygons t

WHERE
    {{ bounds['polygon']|bbox_filter('the_geom',3857) }}

{% endif %}

{% if zoom >= 7 %}

UNION ALL

SELECT
    osm_id AS __id__,
    {% filter geometry %}{{ bounds['polygon']|bbox_intersection('way') }}{% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_earth(t.*) AS mz_properties,
    to_jsonb(tags) || jsonb_build_object(
      'area', way_area::bigint,
      'source', 'openstreetmap.org',
      'min_zoom', mz_earth_min_zoom
    ) AS __properties__

FROM planet_osm_polygon t

WHERE
{% if zoom < 16 %}
    mz_earth_min_zoom < {{ zoom + 1 }} AND
{% else %}
    mz_earth_min_zoom IS NOT NULL AND
{% endif %}
    {{ bounds['polygon']|bbox_filter('way',3857) }}

UNION ALL

SELECT
    osm_id AS __id__,
    {% filter geometry %}{{ bounds['line']|bbox_intersection('way') }}{% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_earth(t.*) AS mz_properties,
    to_jsonb(tags) || jsonb_build_object(
      'source', 'openstreetmap.org',
      'min_zoom', mz_earth_min_zoom
    ) AS __properties__

FROM planet_osm_line t

WHERE
{% if zoom < 16 %}
    mz_earth_min_zoom < {{ zoom + 1 }} AND
{% else %}
    mz_earth_min_zoom IS NOT NULL AND
{% endif %}
    {{ bounds['line']|bbox_filter('way',3857) }}

{% endif %}

UNION ALL

SELECT
  osm_id AS __id__,
  {% filter geometry %}way{% endfilter %} AS __geometry__,
  NULL AS __label__,
  mz_calculate_json_earth(t.*) AS mz_properties,
  to_jsonb(tags) || jsonb_build_object(
    'source', 'openstreetmap.org',
    'min_zoom', mz_earth_min_zoom,
    'label_placement', true
  ) AS __properties__

FROM
  planet_osm_point t

WHERE
{% if zoom < 16 %}
  mz_earth_min_zoom < {{ zoom + 1 }} AND
{% else %}
  mz_earth_min_zoom IS NOT NULL AND
{% endif %}
  {{ bounds['point']|bbox_filter('way',3857) }}
