SELECT
    osm_id AS __id__,
    {% filter geometry %}way{% endfilter %} AS __geometry__,
    mz_properties,
    to_jsonb(tags) || jsonb_build_object(
      'source', 'openstreetmap.org',
      'min_zoom', min_zoom,
      'area', way_area,
      'mz_transit_score', (transit_routes).score,
      'mz_transit_root_relation_id', (transit_routes).root_relation_id,
      'train_routes', (transit_routes).train_routes,
      'subway_routes', (transit_routes).subway_routes,
      'light_rail_routes', (transit_routes).light_rail_routes,
      'tram_routes', (transit_routes).tram_routes
    ) AS __properties__

FROM (

  SELECT
    way, 0::real AS way_area, mz_poi_min_zoom AS min_zoom,
    osm_id,
    -- note: the mz_calculate_transit_routes_and_score function is pretty
    -- expensive, so we only want to calculate it when we actually need the
    -- result.
    CASE
      WHEN tags ? 'railway' AND tags->'railway'='station' AND osm_id > 0
        THEN mz_calculate_transit_routes_and_score(osm_id, NULL)
      ELSE NULL
    END AS transit_routes,
    mz_calculate_json_pois(planet_osm_point.*) AS mz_properties,
    tags

  FROM
    planet_osm_point

  WHERE
    {{ bounds['point']|bbox_filter('way',3857) }}
{% if zoom >= 16 %}
    AND mz_poi_min_zoom IS NOT NULL
{% else %}
    AND mz_poi_min_zoom < {{ zoom + 1 }}
{% endif %}

UNION ALL

  SELECT
    way, way_area, mz_poi_min_zoom AS min_zoom,
    osm_id,
    -- note: the mz_calculate_transit_routes_and_score function is pretty
    -- expensive, so we only want to calculate it when we actually need the
    -- result.
    CASE
      WHEN tags ? 'railway' AND tags->'railway'='station'
        THEN mz_calculate_transit_routes_and_score(NULL, osm_id)
      ELSE NULL
    END AS transit_routes,
    mz_calculate_json_pois(planet_osm_polygon.*) AS mz_properties,
    tags

  FROM
    planet_osm_polygon

  WHERE
    {{ bounds['point']|bbox_filter('way',3857) }}
{% if zoom >= 16 %}
    AND mz_poi_min_zoom IS NOT NULL
{% else %}
    AND mz_poi_min_zoom < {{ zoom + 1 }}
{% endif %}

) pois
