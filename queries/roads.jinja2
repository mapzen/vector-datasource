{% if zoom < 8 %}
SELECT
    gid AS __id__,
    {% filter geometry %}the_geom{% endfilter %} AS __geometry__,
    mz_calculate_json_roads(ne_10m_roads.*) AS mz_properties,
    jsonb_build_object(
      'source', 'naturalearthdata.com',
      'min_zoom', scalerank,
      'scalerank', scalerank,
      'featurecla', featurecla,
      'type', type,
      'expressway', expressway,
      'sov_a3', sov_a3,
      'level', level,
      'continent', continent,
      'label', label,
      'name', name
    ) AS __properties__

FROM ne_10m_roads

WHERE
    {{ bounds['line']|bbox_filter('the_geom',3857) }}
    AND scalerank <= {{ zoom }}

{% else %}

SELECT
    osm_id AS __id__,
    {% filter geometry %}way{% endfilter %} AS __geometry__,
    mz_calculate_json_roads(planet_osm_line.*) AS mz_properties,
    to_jsonb(tags) || jsonb_build_object(
      'source', 'openstreetmap.org',
      'min_zoom', mz_road_level,
{% if zoom >= 12 %}
      'is_bus_route',
      -- try to only calculate whether this is a bus route when we already know
      -- that it's a road, as joining onto the rels table can be expensive.
      CASE WHEN tags->'highway' IN ('motorway', 'motorway_link', 'trunk', 'trunk_link',
                            'primary', 'primary_link', 'secondary', 'secondary_link',
                            'tertiary', 'tertiary_link',
                            'residential', 'unclassified', 'road', 'living_street')
        THEN mz_calculate_is_bus_route(osm_id)
        ELSE NULL
      END,
{% endif %}
      'mz_cycling_network', mz_cycling_network(tags, osm_id),
      'mz_networks', mz_get_rel_networks(osm_id)
    ) AS __properties__

FROM planet_osm_line

WHERE
    {{ bounds['line']|bbox_filter('way',3857) }}
    AND mz_road_level <= {{ zoom }}

{% endif %}
