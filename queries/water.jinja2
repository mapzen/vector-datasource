{% macro ne_water_cols(name) %}
    gid AS __id__,
    {% filter geometry %}{{ bounds['polygon']|bbox_padded_intersection('the_geom') }}{% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_water(t.*) AS mz_properties,
    jsonb_build_object(
      'name', {{ name }},
      'area', way_area::bigint,
      'source', 'naturalearthdata.com',
      'min_zoom', mz_water_min_zoom,
      'featurecla', featurecla
    ) AS __properties__
{% endmacro %}

{% if zoom < 9 %}
SELECT
    {{ ne_water_cols('NULL') }}

{% if zoom < 2 %}
FROM ne_110m_ocean t
{% elif 2 <= zoom < 5 %}
FROM ne_50m_ocean t
{% elif 5 <= zoom < 9 %}
FROM ne_10m_ocean t
{% endif %}

WHERE
  mz_water_min_zoom < {{ zoom + 1 }} AND
  {{ bounds['polygon']|bbox_filter('the_geom',3857) }}

UNION ALL

SELECT
    {{ ne_water_cols('name') }}

{% if zoom < 2 %}
FROM ne_110m_lakes t
{% elif 2 <= zoom < 5 %}
FROM ne_50m_lakes t
{% elif 5 <= zoom < 9 %}
FROM ne_10m_lakes t
{% endif %}

WHERE
  mz_water_min_zoom < {{ zoom + 1 }} AND
  {{ bounds['polygon']|bbox_filter('the_geom',3857) }}

UNION ALL

SELECT
    gid AS __id__,
    {% filter geometry %}{{ bounds['polygon']|bbox_padded_intersection('the_geom') }}{% endfilter %} AS __geometry__,
    NULL AS __label__,
    mz_calculate_json_water(t.*) AS mz_properties,
    jsonb_build_object(
      'source', 'naturalearthdata.com',
      'min_zoom', mz_water_min_zoom,
      'boundary', true,
      'featurecla', featurecla
    ) AS __properties__

FROM
{% if zoom < 2 %}
    ne_110m_coastline t
{% elif 2 <= zoom < 5 %}
    ne_50m_coastline t
{% elif 5 <= zoom < 9 %}
    ne_10m_coastline t
{% endif %}

WHERE
  mz_water_min_zoom < {{ zoom + 1 }} AND
  {{ bounds['line']|bbox_filter('the_geom',3857) }}

UNION ALL

SELECT
    gid AS __id__,
    {% filter geometry %}st_boundary(the_geom){% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_water(t.*) AS mz_properties,
    jsonb_build_object(
      'source', 'naturalearthdata.com',
      'min_zoom', mz_water_min_zoom,
      'boundary', true,
      'featurecla', featurecla
    ) AS __properties__

FROM
{% if zoom < 2 %}
    ne_110m_lakes t
{% elif 2 <= zoom < 5 %}
    ne_50m_lakes t
{% elif 5 <= zoom < 9 %}
    ne_10m_lakes t
{% endif %}

WHERE
  mz_water_min_zoom < {{ zoom + 1 }} AND
  {{ bounds['line']|bbox_filter('the_geom',3857) }}

{% if 4 <= zoom < 9 %}
UNION ALL

SELECT
    {{ ne_water_cols('name') }}

{% if 4 <= zoom < 5 %}
FROM ne_50m_playas t
{% elif 5 <= zoom < 9 %}
FROM ne_10m_playas t
{% endif %}

WHERE
  mz_water_min_zoom < {{ zoom + 1 }} AND
  {{ bounds['polygon']|bbox_filter('the_geom',3857) }}

UNION ALL

SELECT
    gid AS __id__,
    {% filter geometry %}st_boundary(the_geom){% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_water(t.*) AS mz_properties,
    jsonb_build_object(
      'source', 'naturalearthdata.com',
      'min_zoom', mz_water_min_zoom,
      'boundary', true,
      'featurecla', featurecla
    ) AS __properties__

FROM
{% if 4 <= zoom < 5 %}
    ne_50m_playas t
{% elif 5 <= zoom < 9 %}
    ne_10m_playas t
{% endif %}

WHERE
  mz_water_min_zoom < {{ zoom + 1 }} AND
  {{ bounds['line']|bbox_filter('the_geom',3857) }}

{% endif %}

{% elif 9 <= zoom %}
SELECT
    gid AS __id__,
    {% filter geometry %}{{ bounds['polygon']|bbox_padded_intersection('the_geom') }}{% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_water(t.*) AS mz_properties,
    jsonb_build_object(
      'name', '',
      'area', way_area::bigint,
      'source', 'openstreetmapdata.com',
      'min_zoom', mz_water_min_zoom
    ) AS __properties__

FROM water_polygons t

WHERE {{ bounds['polygon']|bbox_filter('the_geom',3857) }}

UNION ALL

SELECT
    osm_id AS __id__,
    {% filter geometry %}{{ bounds['polygon']|bbox_padded_intersection('way') }}{% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_water(t.*) AS mz_properties,
    to_jsonb(tags) || jsonb_build_object(
      'area', way_area::bigint,
      'source', 'openstreetmap.org',
      'min_zoom', mz_water_min_zoom
    ) AS __properties__

FROM planet_osm_polygon t

WHERE
{% if zoom >= 16 %}
    mz_water_min_zoom IS NOT NULL AND
{% else %}
    mz_water_min_zoom < {{ zoom + 1 }} AND
{% endif %}
    {{ bounds['polygon']|bbox_filter('way',3857) }}

UNION ALL

SELECT
    osm_id AS __id__,
    {% filter geometry %}{{ bounds['line']|bbox_padded_intersection('way') }}{% endfilter %} AS __geometry__,
    {% filter geometry %}mz_label_placement{% endfilter %} AS __label__,
    mz_calculate_json_water(t.*) AS mz_properties,
    to_jsonb(tags) || jsonb_build_object(
      'source', 'openstreetmap.org',
      'min_zoom', mz_water_min_zoom
    ) AS __properties__

FROM planet_osm_line t

WHERE
{% if zoom >= 16 %}
    mz_water_min_zoom IS NOT NULL AND
{% else %}
    mz_water_min_zoom < {{ zoom + 1 }} AND
{% endif %}
    {{ bounds['line']|bbox_filter('way',3857) }}

{% endif %}

UNION ALL

SELECT
  osm_id AS __id__,
  {% filter geometry %}way{% endfilter %} AS __geometry__,
  NULL AS __label__,
  mz_calculate_json_water(t.*) AS mz_properties,
  to_jsonb(tags) || jsonb_build_object(
    'source', 'openstreetmap.org',
    'min_zoom', mz_water_min_zoom,
    'label_placement', true
  ) AS __properties__

FROM
  planet_osm_point t

WHERE
{% if zoom >= 16 %}
  mz_water_min_zoom IS NOT NULL AND
{% else %}
  mz_water_min_zoom < {{ zoom + 1 }} AND
{% endif %}
  {{ bounds['point']|bbox_filter('way',3857) }}
